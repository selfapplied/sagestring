<!DOCTYPE html>
<html>
<head>
    <title>SVG Kernel 3D: Volumetric Pattern Recognition</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            margin: 20px;
            overflow-x: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            max-width: 1600px;
        }
        .main-panel {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }
        .visualization-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
        }
        .viz-container {
            position: relative;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
        }
        #viz-3d, #viz-2d {
            width: 100%;
            height: 400px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        button {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        button:hover {
            background: #3a3a3a;
        }
        button.active {
            background: #4a4a4a;
            border-color: #666;
        }
        button:disabled {
            background: #1a1a1a;
            color: #666;
            cursor: not-allowed;
        }
        .stats-panel {
            font-size: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-item {
            background: #0f0f0f;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #4ecdc4;
        }
        .kernel-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
        }
        .kernel-item {
            background: #0f0f0f;
            margin: 4px 0;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            border-left: 3px solid #4ecdc4;
        }
        .kernel-item:hover {
            background: #1a1a1a;
        }
        .kernel-item.active {
            border-left-color: #ff6b6b;
            background: #2a2a2a;
        }
        .settings-panel {
            margin-top: 20px;
        }
        .setting-group {
            margin: 15px 0;
        }
        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        input[type="range"] {
            width: 100%;
        }
        .setting-value {
            font-size: 11px;
            color: #888;
            text-align: right;
        }
        select {
            width: 100%;
            background: #0f0f0f;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        .extrusion-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .extrusion-method {
            background: #0f0f0f;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            font-size: 11px;
            border: 1px solid #333;
        }
        .extrusion-method:hover {
            background: #1a1a1a;
        }
        .extrusion-method.active {
            border-color: #4ecdc4;
            background: #2a2a2a;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }
        .slice-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .slice-control {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .slice-control input {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>üåê SVG Kernel 3D: Volumetric Pattern Recognition</h1>
    <p>Extrude 2D SVG shapes into 3D volumes, evolve through cellular automata, and visualize in real-time 3D space</p>

    <div class="container">
        <div class="main-panel">
            <div class="visualization-section">
                <div class="panel">
                    <h3>3D Volumetric Visualization</h3>
                    <div class="viz-container">
                        <div id="viz-3d"></div>
                    </div>
                    <div class="slice-controls">
                        <div class="slice-control">
                            <label>X Slice</label>
                            <input type="range" id="slice-x" min="0" max="63" value="32">
                        </div>
                        <div class="slice-control">
                            <label>Y Slice</label>
                            <input type="range" id="slice-y" min="0" max="63" value="32">
                        </div>
                        <div class="slice-control">
                            <label>Z Slice</label>
                            <input type="range" id="slice-z" min="0" max="31" value="16">
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>2D Slice View</h3>
                    <div class="viz-container">
                        <canvas id="viz-2d" width="400" height="400"></canvas>
                    </div>
                    <div style="margin-top: 10px;">
                        <select id="slice-axis">
                            <option value="z">XY Plane (Z slice)</option>
                            <option value="y">XZ Plane (Y slice)</option>
                            <option value="x">YZ Plane (X slice)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="init-btn" onclick="initializeSystem()">Initialize 3D System</button>
                <button id="create-3d-btn" onclick="create3DKernel()" disabled>Create 3D Kernel</button>
                <button id="evolve-btn" onclick="evolve3DKernel()" disabled>Evolve 3D</button>
                <button id="visualize-btn" onclick="visualize3DKernel()" disabled>Visualize</button>
                <button onclick="resetSystem()">Reset</button>
                <button onclick="exportVisualization()">Export</button>
            </div>
        </div>

        <div class="side-panel">
            <div class="panel stats-panel">
                <h3>3D Kernel Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div>Voxels</div>
                        <div class="stat-value" id="voxels-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div>Density</div>
                        <div class="stat-value" id="density-value">0.0%</div>
                    </div>
                    <div class="stat-item">
                        <div>Avg Intensity</div>
                        <div class="stat-value" id="intensity-value">0.0</div>
                    </div>
                    <div class="stat-item">
                        <div>Volume</div>
                        <div class="stat-value" id="volume-value">0</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="panel">
                <h3>3D Kernels</h3>
                <div class="kernel-list" id="kernel-list">
                    <div style="color: #666; font-style: italic;">No 3D kernels created</div>
                </div>
            </div>

            <div class="panel">
                <h3>Extrusion Methods</h3>
                <div class="extrusion-methods" id="extrusion-methods"></div>
                <div class="setting-group">
                    <label>Depth</label>
                    <input type="range" id="extrusion-depth" min="8" max="64" value="16" step="4">
                    <div class="setting-value" id="depth-value-display">16</div>
                </div>
            </div>

            <div class="panel settings-panel">
                <h3>Visualization Settings</h3>

                <div class="setting-group">
                    <label>Visualization Mode</label>
                    <select id="viz-mode">
                        <option value="points">Point Cloud</option>
                        <option value="volume">Voxel Volume</option>
                        <option value="isosurface">Isosurface</option>
                        <option value="slices">Slice Planes</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label>Point Size</label>
                    <input type="range" id="point-size" min="1" max="10" value="2" step="0.5">
                    <div class="setting-value" id="point-size-display">2.0</div>
                </div>

                <div class="setting-group">
                    <label>Threshold</label>
                    <input type="range" id="threshold" min="0.1" max="0.9" value="0.3" step="0.05">
                    <div class="setting-value" id="threshold-display">0.3</div>
                </div>

                <div class="setting-group">
                    <label>Opacity</label>
                    <input type="range" id="opacity" min="0.1" max="1.0" value="0.8" step="0.05">
                    <div class="setting-value" id="opacity-display">0.8</div>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="enable-rotation" checked> Auto Rotation
                    </label>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="show-axes" checked> Show Axes
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script src="svg_kernel_system.js"></script>
    <script src="svg_kernel_3d_system.js"></script>
    <script src="svg_kernel_3d_visualization.js"></script>
    <script>
        let kernelSystem;
        let system3D;
        let visualization;
        let isInitialized = false;
        let currentKernelId = null;
        let currentVisData = null;

        // Settings
        const settings = {
            extrusionMethod: 'linear',
            extrusionDepth: 16,
            vizMode: 'points',
            pointSize: 2.0,
            threshold: 0.3,
            opacity: 0.8,
            enableRotation: true,
            showAxes: true
        };

        async function initializeSystem() {
            try {
                updateStatus("Initializing 3D volumetric system...");

                // Initialize core systems
                kernelSystem = new SVGKernelSystem();
                system3D = new SVGKernel3DSystem(kernelSystem);

                // Create fundamental 2D kernels first
                const ce1System = new (class { async initialize() { return this; } })();
                await createFundamentalKernels();

                // Initialize 3D visualization
                visualization = new SVGKernel3DVisualization('viz-3d', {
                    backgroundColor: 0x0a0a0a,
                    pointSize: settings.pointSize,
                    enableRotation: settings.enableRotation,
                    showAxes: settings.showAxes
                });
                await visualization.initialize();

                isInitialized = true;
                updateButtons();
                updateExtrusionMethods();
                updateStatus("3D system initialized. Create some 3D kernels!");

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus(`Initialization failed: ${error.message}`);
            }
        }

        async function createFundamentalKernels() {
            // Create fundamental 2D kernels
            const fundamentalKernels = [
                { id: 'spiral', xml: `<kernel id="spiral" energy="1.2" power="2.0">
                    <shape><path d="M128 128 L128 108 A20 20 0 0 1 148 128 L168 128 A40 40 0 0 0 128 168 L128 188 A60 60 0 0 1 68 128 L48 128 A80 80 0 0 0 128 48 Z" stroke="#00ff88" stroke-width="3"/></shape>
                    <discrete><lattice size="256" boundary="wrap"/></discrete>
                    <invariants><scale-invariance/><mirror-symmetry/></invariants>
                </kernel>` },
                { id: 'wave', xml: `<kernel id="wave" energy="1.0" power="1.8">
                    <shape><path d="M0 128 Q64 64 128 128 T256 128" stroke="#0088ff" stroke-width="4"/></shape>
                    <discrete><lattice size="256" boundary="wrap"/></discrete>
                    <invariants><scale-invariance/></invariants>
                </kernel>` },
                { id: 'circle', xml: `<kernel id="circle" energy="1.5" power="2.2">
                    <shape><circle cx="128" cy="128" r="60" stroke="#ff8800" stroke-width="4"/></shape>
                    <discrete><lattice size="256" boundary="wrap"/></discrete>
                    <invariants><scale-invariance/><rotation-invariance/></invariants>
                </kernel>` }
            ];

            for (const kernel of fundamentalKernels) {
                const parsed = kernelSystem.parseKernel(kernel.xml);
                kernelSystem.discretizeKernel(parsed[0]);
            }
        }

        function create3DKernel() {
            if (!isInitialized) {
                updateStatus("Initialize system first!");
                return;
            }

            const baseKernelSelect = document.getElementById('base-kernel-select');
            const baseKernelId = baseKernelSelect ? baseKernelSelect.value : 'spiral';

            if (!kernelSystem.kernels.has(baseKernelId)) {
                updateStatus(`Base kernel ${baseKernelId} not found!`);
                return;
            }

            updateStatus(`Creating 3D kernel from ${baseKernelId} using ${settings.extrusionMethod} extrusion...`);

            try {
                const kernel3D = system3D.create3DKernel(baseKernelId, {
                    extrusionMethod: settings.extrusionMethod,
                    extrusionDepth: settings.extrusionDepth,
                    latticeSize: { x: 64, y: 64, z: 32 }
                });

                currentKernelId = kernel3D.id;
                updateKernelList();
                updateStats(system3D.getKernelStats(currentKernelId));
                updateStatus(`Created 3D kernel: ${currentKernelId}`);

            } catch (error) {
                console.error('3D kernel creation error:', error);
                updateStatus(`Failed to create 3D kernel: ${error.message}`);
            }
        }

        function evolve3DKernel() {
            if (!currentKernelId) {
                updateStatus("Create a 3D kernel first!");
                return;
            }

            const steps = 3;
            updateStatus(`Evolving 3D kernel ${currentKernelId} for ${steps} steps...`);

            setProgress(0);
            for (let i = 0; i < steps; i++) {
                setTimeout(() => {
                    system3D.evolve3DLattice(currentKernelId, 1);
                    setProgress((i + 1) / steps * 100);

                    if (i === steps - 1) {
                        updateStats(system3D.getKernelStats(currentKernelId));
                        updateStatus(`Evolution complete for ${currentKernelId}`);
                    }
                }, i * 100);
            }
        }

        function visualize3DKernel() {
            if (!currentKernelId) {
                updateStatus("Create and evolve a 3D kernel first!");
                return;
            }

            updateStatus(`Visualizing 3D kernel ${currentKernelId}...`);

            try {
                // Create visualization data
                currentVisData = system3D.createVisualizationData(currentKernelId, {
                    threshold: settings.threshold,
                    maxPoints: 20000
                });

                if (currentVisData) {
                    // Visualize in 3D
                    visualization.visualizeKernel(currentKernelId, currentVisData, settings.vizMode);
                    visualization.updateParameters({
                        pointSize: settings.pointSize,
                        opacity: settings.opacity,
                        enableRotation: settings.enableRotation
                    });

                    // Show 2D slice
                    update2DSlice();

                    updateStatus(`3D visualization created for ${currentKernelId}`);
                } else {
                    updateStatus("No visualization data generated");
                }

            } catch (error) {
                console.error('Visualization error:', error);
                updateStatus(`Visualization failed: ${error.message}`);
            }
        }

        function update2DSlice() {
            if (!currentKernelId || !currentVisData) return;

            const axis = document.getElementById('slice-axis').value;
            const sliceIndex = axis === 'x' ? parseInt(document.getElementById('slice-x').value) :
                             axis === 'y' ? parseInt(document.getElementById('slice-y').value) :
                             parseInt(document.getElementById('slice-z').value);

            const slice = system3D.extractSlice(currentKernelId, axis, sliceIndex);
            if (slice) {
                render2DSlice(slice);
            }
        }

        function render2DSlice(slice) {
            const canvas = document.getElementById('viz-2d');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(slice.width, slice.height);

            // Convert slice data to RGBA
            for (let i = 0; i < slice.data.length; i++) {
                const value = Math.floor(slice.data[i] * 255);
                imageData.data[i * 4] = value;     // R
                imageData.data[i * 4 + 1] = value; // G
                imageData.data[i * 4 + 2] = value; // B
                imageData.data[i * 4 + 3] = 255;   // A
            }

            // Scale to fit canvas
            const scale = Math.min(canvas.width / slice.width, canvas.height / slice.height);
            const scaledWidth = slice.width * scale;
            const scaledHeight = slice.height * scale;
            const offsetX = (canvas.width - scaledWidth) / 2;
            const offsetY = (canvas.height - scaledHeight) / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.putImageData(imageData, offsetX, offsetY, 0, 0, scaledWidth, scaledHeight);
        }

        function updateExtrusionMethods() {
            const container = document.getElementById('extrusion-methods');
            const methods = system3D.getExtrusionMethods();

            container.innerHTML = methods.map(method => `
                <div class="extrusion-method ${method.name === settings.extrusionMethod ? 'active' : ''}"
                     onclick="setExtrusionMethod('${method.name}')">
                    <strong>${method.name}</strong><br>
                    <small>${method.description}</small>
                </div>
            `).join('');
        }

        function setExtrusionMethod(method) {
            settings.extrusionMethod = method;
            updateExtrusionMethods();
        }

        function updateKernelList() {
            const list = document.getElementById('kernel-list');
            const kernels = system3D.list3DKernels();

            list.innerHTML = kernels.map(kernel => `
                <div class="kernel-item ${kernel.id === currentKernelId ? 'active' : ''}"
                     onclick="selectKernel('${kernel.id}')">
                    <div><strong>${kernel.id}</strong></div>
                    <div>Method: ${kernel.stats.extrusionMethod}</div>
                    <div>Density: ${(kernel.stats.density * 100).toFixed(1)}%</div>
                </div>
            `).join('');
        }

        function selectKernel(kernelId) {
            currentKernelId = kernelId;
            updateKernelList();
            updateStats(system3D.getKernelStats(kernelId));
        }

        function updateStats(stats) {
            if (!stats) return;

            document.getElementById('voxels-value').textContent = stats.occupiedVoxels.toLocaleString();
            document.getElementById('density-value').textContent = (stats.density * 100).toFixed(1) + '%';
            document.getElementById('intensity-value').textContent = stats.avgIntensity.toFixed(3);
            document.getElementById('volume-value').textContent = stats.volume.toLocaleString();
        }

        function setProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function updateButtons() {
            const initBtn = document.getElementById('init-btn');
            const createBtn = document.getElementById('create-3d-btn');
            const evolveBtn = document.getElementById('evolve-btn');
            const visualizeBtn = document.getElementById('visualize-btn');

            initBtn.disabled = isInitialized;
            createBtn.disabled = !isInitialized;
            evolveBtn.disabled = !currentKernelId;
            visualizeBtn.disabled = !currentKernelId;
        }

        function resetSystem() {
            if (visualization) {
                visualization.dispose();
            }

            kernelSystem = null;
            system3D = null;
            visualization = null;
            isInitialized = false;
            currentKernelId = null;
            currentVisData = null;

            // Clear canvases
            const canvas2D = document.getElementById('viz-2d');
            const ctx = canvas2D.getContext('2d');
            ctx.clearRect(0, 0, canvas2D.width, canvas2D.height);

            updateButtons();
            updateStats(null);
            updateKernelList();
            updateStatus("System reset");
        }

        function exportVisualization() {
            if (!visualization || !visualization.isReady()) {
                alert('No visualization to export. Create and visualize a 3D kernel first.');
                return;
            }

            const screenshot = visualization.takeScreenshot();
            const link = document.createElement('a');
            link.download = `svg-kernel-3d-${currentKernelId || 'viz'}.png`;
            link.href = screenshot;
            link.click();

            updateStatus('Visualization exported');
        }

        function updateStatus(message) {
            console.log(message);
            // Could add status display here
        }

        // Settings event listeners
        document.getElementById('extrusion-depth').addEventListener('input', (e) => {
            settings.extrusionDepth = parseInt(e.target.value);
            document.getElementById('depth-value-display').textContent = settings.extrusionDepth;
        });

        document.getElementById('viz-mode').addEventListener('change', (e) => {
            settings.vizMode = e.target.value;
            if (currentVisData) {
                visualization.setVisualizationMode(settings.vizMode);
            }
        });

        document.getElementById('point-size').addEventListener('input', (e) => {
            settings.pointSize = parseFloat(e.target.value);
            document.getElementById('point-size-display').textContent = settings.pointSize;
            if (visualization) {
                visualization.updateParameters({ pointSize: settings.pointSize });
            }
        });

        document.getElementById('threshold').addEventListener('input', (e) => {
            settings.threshold = parseFloat(e.target.value);
            document.getElementById('threshold-display').textContent = settings.threshold;
            if (currentKernelId) {
                visualize3DKernel(); // Re-visualize with new threshold
            }
        });

        document.getElementById('opacity').addEventListener('input', (e) => {
            settings.opacity = parseFloat(e.target.value);
            document.getElementById('opacity-display').textContent = settings.opacity;
            if (visualization) {
                visualization.updateParameters({ opacity: settings.opacity });
            }
        });

        document.getElementById('enable-rotation').addEventListener('change', (e) => {
            settings.enableRotation = e.target.checked;
            if (visualization) {
                visualization.updateParameters({ enableRotation: settings.enableRotation });
            }
        });

        document.getElementById('show-axes').addEventListener('change', (e) => {
            settings.showAxes = e.target.checked;
            // Would need to re-initialize visualization to change axes
        });

        // Slice controls
        ['slice-x', 'slice-y', 'slice-z'].forEach(id => {
            document.getElementById(id).addEventListener('input', update2DSlice);
        });
        document.getElementById('slice-axis').addEventListener('change', update2DSlice);

        // Initialize settings display
        document.getElementById('depth-value-display').textContent = settings.extrusionDepth;
        document.getElementById('point-size-display').textContent = settings.pointSize;
        document.getElementById('threshold-display').textContent = settings.threshold;
        document.getElementById('opacity-display').textContent = settings.opacity;

        // Initial status
        updateStatus("Ready to initialize 3D volumetric system");
    </script>
</head>
</html>

