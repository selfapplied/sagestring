<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CE Fractal Sobel Chatbot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Monaco', 'Menlo', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    .header {
      grid-column: 1 / -1;
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      border-bottom: 2px solid #4a9eff;
    }
    h1 {
      color: #4a9eff;
      margin-bottom: 10px;
      font-size: 24px;
    }
    .subtitle {
      color: #888;
      font-size: 14px;
    }
    .chat-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 600px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #0f0f0f;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .message {
      margin: 15px 0;
      padding: 12px;
      border-radius: 6px;
      max-width: 80%;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user {
      background: #2a2a2a;
      margin-left: auto;
      border-left: 3px solid #4a9eff;
    }
    .message.bot {
      background: #1a2a1a;
      margin-right: auto;
      border-left: 3px solid #4a9eff;
    }
    .message-header {
      font-size: 11px;
      color: #888;
      margin-bottom: 6px;
    }
    .message-content {
      font-size: 14px;
      line-height: 1.6;
    }
    .message-generating {
      color: #888;
      font-style: italic;
    }
    .chat-input-container {
      display: flex;
      gap: 10px;
    }
    input[type="text"] {
      flex: 1;
      background: #0f0f0f;
      border: 1px solid #444;
      color: #e0e0e0;
      padding: 12px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4a9eff;
    }
    button {
      background: #4a9eff;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #5aaeff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .side-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      max-height: 600px;
    }
    .side-panel h2 {
      color: #4a9eff;
      font-size: 18px;
      margin-bottom: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat {
      background: #2a2a2a;
      padding: 10px;
      border-radius: 4px;
    }
    .stat-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      color: #4a9eff;
      font-weight: bold;
    }
    .witness-status {
      padding: 15px;
      background: #2a2a2a;
      border-radius: 4px;
      border-left: 4px solid #4a9eff;
      margin-bottom: 20px;
    }
    .witness-status.low {
      border-left-color: #ff6b6b;
    }
    .witness-status.medium {
      border-left-color: #ffaa44;
    }
    .word-vis {
      margin-top: 15px;
    }
    .word-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    .word {
      padding: 4px 8px;
      background: #2a2a2a;
      border-radius: 3px;
      font-size: 11px;
    }
    .word.edge {
      border: 1px solid #ff6b6b;
      background: #3a2a2a;
    }
    .word.edge.strong {
      border-color: #ff4444;
    }
    .edge-list {
      margin-top: 15px;
      font-size: 11px;
    }
    .edge-item {
      padding: 6px;
      background: #2a2a2a;
      border-radius: 3px;
      margin: 4px 0;
      border-left: 2px solid #ff6b6b;
    }
    .fractal-info {
      margin-top: 15px;
      font-size: 11px;
      color: #888;
    }
    .field-evolution {
      margin-top: 15px;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 4px;
      font-size: 11px;
    }
    .field-evolution code {
      color: #4a9eff;
      display: block;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CE Fractal Sobel Chatbot</h1>
      <p class="subtitle">Text generation using fractal word fields and semantic edge detection</p>
    </div>
    
    <div class="chat-panel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-container">
        <input type="text" id="chatInput" placeholder="Type your message..." />
        <button id="sendButton" onclick="sendMessage()">Send</button>
      </div>
    </div>
    
    <div class="side-panel">
      <h2>Field Status</h2>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Coherence</div>
          <div class="stat-value" id="coherenceValue">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Antclock</div>
          <div class="stat-value" id="antclockValue">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Words</div>
          <div class="stat-value" id="wordsValue">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">κ Bound</div>
          <div class="stat-value" id="kappaValue">—</div>
        </div>
      </div>
      
      <div id="witnessStatus" class="witness-status">
        <strong>Witness:</strong> <span id="witnessText">—</span>
      </div>
      
      <div class="word-vis">
        <h2>Last Response</h2>
        <div id="wordGrid" class="word-grid"></div>
      </div>
      
      <div class="edge-list">
        <h2>Semantic Edges</h2>
        <div id="edgeList"></div>
      </div>
      
      <div class="field-evolution">
        <h2>Field Evolution</h2>
        <code>Sentence_{a+1} = []W_a + ()(W_a → W_{a+1}) + &lt;&gt;_stability</code>
        <code>Δ coherence = |&lt;&gt;_{n+1} - &lt;&gt;_n| &lt; κ</code>
      </div>
      
      <div class="fractal-info">
        <h2>Fractal Structure</h2>
        <div id="fractalInfo" style="margin-top: 10px; font-size: 10px; color: #666;"></div>
      </div>
    </div>
  </div>
  
  <script src="ce_fractal_sobel.js"></script>
  <script>
    const sobel = new CEFractalSobel({ kappa: 0.35 });
    sobel.initializeVocabulary();
    
    let isGenerating = false;
    
    // Enter key to send
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !isGenerating) {
        sendMessage();
      }
    });
    
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || isGenerating) return;
      
      // Add user message
      addMessage('user', message);
      input.value = '';
      isGenerating = true;
      document.getElementById('sendButton').disabled = true;
      
      // Show generating message
      const generatingId = addMessage('bot', 'Generating response...', true);
      
      // Generate response using fractal Sobel
      setTimeout(() => {
        try {
          const response = sobel.generateResponse(message, { maxWords: 20 });
          
          // Remove generating message
          removeMessage(generatingId);
          
          // Add response
          addMessage('bot', response.text, false, response);
          
          // Update status
          updateStatus(response);
          
        } catch (error) {
          removeMessage(generatingId);
          addMessage('bot', `Error: ${error.message}`);
        } finally {
          isGenerating = false;
          document.getElementById('sendButton').disabled = false;
          input.focus();
        }
      }, 300);
    }
    
    function addMessage(type, content, isGenerating = false, responseData = null) {
      const messages = document.getElementById('chatMessages');
      const messageId = 'msg-' + Date.now();
      const message = document.createElement('div');
      message.id = messageId;
      message.className = `message ${type}`;
      
      const header = document.createElement('div');
      header.className = 'message-header';
      if (type === 'user') {
        header.textContent = `You (a=${sobel.antclock})`;
      } else {
        header.textContent = isGenerating 
          ? 'Bot (generating...)' 
          : `Bot (a=${responseData?.antclock || sobel.antclock}, coherence=${responseData?.coherence?.toFixed(3) || '—'})`;
      }
      message.appendChild(header);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = isGenerating ? 'message-content message-generating' : 'message-content';
      contentDiv.textContent = content;
      message.appendChild(contentDiv);
      
      messages.appendChild(message);
      messages.scrollTop = messages.scrollHeight;
      
      return messageId;
    }
    
    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) message.remove();
    }
    
    function updateStatus(responseData = null) {
      const status = sobel.getStatus();
      
      if (responseData) {
        document.getElementById('coherenceValue').textContent = responseData.coherence.toFixed(3);
        document.getElementById('antclockValue').textContent = responseData.antclock;
        document.getElementById('wordsValue').textContent = responseData.words.length;
        
        // Update witness
        const witnessEl = document.getElementById('witnessStatus');
        const witnessText = document.getElementById('witnessText');
        witnessText.textContent = `Coherence: ${responseData.witness.coherence.toFixed(3)}, Stability: ${responseData.witness.stability.toFixed(3)}`;
        
        if (responseData.witness.coherence < 0.65) {
          witnessEl.className = 'witness-status low';
        } else if (responseData.witness.coherence < 0.85) {
          witnessEl.className = 'witness-status medium';
        } else {
          witnessEl.className = 'witness-status';
        }
        
        // Display word grid with edges
        displayWordGrid(responseData.words, responseData.edges);
        
        // Display edges
        displayEdges(responseData.edges);
        
        // Display fractal info
        displayFractalInfo(responseData.words);
      } else {
        document.getElementById('coherenceValue').textContent = status.witness.coherence.toFixed(3);
        document.getElementById('antclockValue').textContent = status.antclock;
        document.getElementById('wordsValue').textContent = status.words;
      }
      
      document.getElementById('kappaValue').textContent = status.kappa.toFixed(2);
    }
    
    function displayWordGrid(words, edges) {
      const grid = document.getElementById('wordGrid');
      grid.innerHTML = '';
      
      const edgeMap = new Map(edges.map(e => [e.position, e]));
      
      words.forEach((word, i) => {
        const wordEl = document.createElement('div');
        wordEl.className = 'word';
        
        const edge = edgeMap.get(i);
        if (edge) {
          wordEl.classList.add('edge', edge.type);
        }
        
        wordEl.textContent = word.text;
        wordEl.title = `Energy: ${word.energy.toFixed(2)}, Coherence: ${word.coherence.toFixed(2)}`;
        grid.appendChild(wordEl);
      });
    }
    
    function displayEdges(edges) {
      const list = document.getElementById('edgeList');
      list.innerHTML = '';
      
      if (edges.length === 0) {
        list.textContent = 'No semantic edges detected.';
        return;
      }
      
      edges.forEach(edge => {
        const item = document.createElement('div');
        item.className = 'edge-item';
        item.textContent = `${edge.word} (${edge.type}, mag: ${edge.magnitude.toFixed(2)})`;
        list.appendChild(item);
      });
    }
    
    function displayFractalInfo(words) {
      const totalLetters = words.reduce((sum, w) => sum + w.letters.length, 0);
      const totalSyllables = words.reduce((sum, w) => sum + w.syllables.length, 0);
      const avgEnergy = words.reduce((sum, w) => sum + w.energy, 0) / words.length;
      
      const fractalInfo = document.getElementById('fractalInfo');
      if (fractalInfo) {
        fractalInfo.innerHTML = `
          Words: ${words.length}<br>
          Letters: ${totalLetters}<br>
          Syllables: ${totalSyllables}<br>
          Avg Energy: ${avgEnergy.toFixed(2)}
        `;
      }
    }
    
    // Initial greeting
    window.addEventListener('load', () => {
      setTimeout(() => {
        addMessage('bot', 'Hello. I generate text using fractal word fields and semantic edge detection. What would you like to talk about?');
        updateStatus();
      }, 500);
    });
  </script>
</body>
</html>
