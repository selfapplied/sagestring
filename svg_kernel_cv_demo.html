<!DOCTYPE html>
<html>
<head>
    <title>SVG Kernel Real-Time CV: Live Pattern Recognition</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            margin: 20px;
            overflow-x: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            max-width: 1400px;
        }
        .main-panel {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }
        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
        }
        .video-container {
            position: relative;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
        }
        video, canvas {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 4px;
        }
        .overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        button {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        button:hover {
            background: #3a3a3a;
        }
        button.active {
            background: #4a4a4a;
            border-color: #666;
        }
        .stats-panel {
            font-size: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-item {
            background: #0f0f0f;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
        }
        .detection-list {
            max-height: 300px;
            overflow-y: auto;
            font-size: 11px;
        }
        .detection-item {
            background: #0f0f0f;
            margin: 4px 0;
            padding: 6px;
            border-radius: 3px;
            border-left: 3px solid #4ecdc4;
        }
        .confidence-bar {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            transition: width 0.3s ease;
        }
        .kernel-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        .kernel-item {
            background: #0f0f0f;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
        }
        .kernel-active {
            border: 1px solid #4ecdc4;
        }
        .processing-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }
        .processing-indicator.active {
            background: #4ecdc4;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .settings-panel {
            margin-top: 20px;
        }
        .setting-group {
            margin: 15px 0;
        }
        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        input[type="range"] {
            width: 100%;
        }
        .setting-value {
            font-size: 11px;
            color: #888;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>ðŸ”® SVG Kernel Real-Time CV: Live Pattern Recognition</h1>
    <p>Self-evolving SVG kernels detecting patterns in real-time video streams</p>

    <div class="container">
        <div class="main-panel">
            <div class="video-section">
                <div class="panel">
                    <h3>Live Video Feed</h3>
                    <div class="video-container">
                        <video id="video-feed" autoplay muted></video>
                        <div class="processing-indicator" id="processing-indicator"></div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Pattern Detections</h3>
                    <div class="video-container">
                        <canvas id="detection-canvas"></canvas>
                        <canvas class="overlay-canvas" id="overlay-canvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="init-btn" onclick="initializeSystem()">Initialize CV</button>
                <button id="start-btn" onclick="startDetection()" disabled>Start Detection</button>
                <button id="stop-btn" onclick="stopDetection()" disabled>Stop</button>
                <button onclick="resetSystem()">Reset</button>
                <button onclick="exportData()">Export Data</button>
            </div>
        </div>

        <div class="side-panel">
            <div class="panel stats-panel">
                <h3>System Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div>FPS</div>
                        <div class="stat-value" id="fps-value">0.0</div>
                    </div>
                    <div class="stat-item">
                        <div>Detections</div>
                        <div class="stat-value" id="detections-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div>Avg Confidence</div>
                        <div class="stat-value" id="confidence-value">0.0%</div>
                    </div>
                    <div class="stat-item">
                        <div>Processing Time</div>
                        <div class="stat-value" id="processing-value">0.0ms</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>Recent Detections</h3>
                <div class="detection-list" id="detection-list">
                    <div style="color: #666; font-style: italic;">No detections yet...</div>
                </div>
            </div>

            <div class="panel">
                <h3>Active Kernels</h3>
                <div class="kernel-status" id="kernel-status">
                    <div style="color: #666; font-style: italic;">Kernels not loaded</div>
                </div>
            </div>

            <div class="panel settings-panel">
                <h3>Detection Settings</h3>

                <div class="setting-group">
                    <label>Confidence Threshold</label>
                    <input type="range" id="confidence-threshold" min="0.1" max="0.9" step="0.1" value="0.5">
                    <div class="setting-value" id="confidence-value-display">0.5</div>
                </div>

                <div class="setting-group">
                    <label>Detection Threshold</label>
                    <input type="range" id="detection-threshold" min="0.3" max="0.9" step="0.05" value="0.7">
                    <div class="setting-value" id="detection-value-display">0.7</div>
                </div>

                <div class="setting-group">
                    <label>NMS Threshold</label>
                    <input type="range" id="nms-threshold" min="0.1" max="0.8" step="0.05" value="0.3">
                    <div class="setting-value" id="nms-value-display">0.3</div>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="temporal-filter" checked> Temporal Filtering
                    </label>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="show-debug" checked> Show Debug Info
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script src="svg_kernel_system.js"></script>
    <script src="feg_kernel_runtime.js"></script>
    <script src="svg_kernel_ce1_integration.js"></script>
    <script src="svg_kernel_cv_system.js"></script>
    <script>
        let kernelSystem;
        let ce1System;
        let cvSystem;
        let isInitialized = false;
        let isRunning = false;
        let recentDetections = [];

        // Settings
        const settings = {
            confidenceThreshold: 0.5,
            detectionThreshold: 0.7,
            nmsThreshold: 0.3,
            temporalFilter: true,
            showDebug: true
        };

        async function initializeSystem() {
            try {
                updateStatus("Initializing SVG Kernel CV System...");

                // Initialize core systems
                kernelSystem = new SVGKernelSystem();
                ce1System = new SVGKernelCE1System();

                // Initialize with fundamental kernels
                await ce1System.initialize();

                // Initialize CV system
                cvSystem = new SVGKernelCVSystem(kernelSystem, {
                    frameRate: 30,
                    resolution: { width: 640, height: 480 },
                    bufferSize: 10
                });

                // Initialize video
                const { video, canvas } = await cvSystem.initializeVideo();
                document.getElementById('video-feed').srcObject = video.srcObject;

                // Set up detection canvas
                const detectionCanvas = document.getElementById('detection-canvas');
                detectionCanvas.width = 640;
                detectionCanvas.height = 480;

                // Draw video to detection canvas initially
                const ctx = detectionCanvas.getContext('2d');
                const drawVideo = () => {
                    if (video.videoWidth > 0) {
                        ctx.drawImage(video, 0, 0, detectionCanvas.width, detectionCanvas.height);
                    }
                    if (!isRunning) {
                        requestAnimationFrame(drawVideo);
                    }
                };
                drawVideo();

                isInitialized = true;
                updateButtons();
                updateKernelStatus();
                updateStatus("System initialized. Click 'Start Detection' to begin.");

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus(`Initialization failed: ${error.message}`);
            }
        }

        async function startDetection() {
            if (!isInitialized) {
                updateStatus("Initialize system first!");
                return;
            }

            try {
                updateStatus("Starting real-time detection...");

                await cvSystem.startDetection({
                    confidenceThreshold: settings.confidenceThreshold,
                    detectionThreshold: settings.detectionThreshold,
                    nmsThreshold: settings.nmsThreshold,
                    temporalFilter: settings.temporalFilter,
                    onFrameProcessed: handleFrameProcessed
                });

                isRunning = true;
                updateButtons();
                updateStatus("Real-time detection active");

            } catch (error) {
                console.error('Start detection error:', error);
                updateStatus(`Detection start failed: ${error.message}`);
            }
        }

        function stopDetection() {
            if (cvSystem) {
                cvSystem.stopDetection();
            }
            isRunning = false;
            updateButtons();
            updateStatus("Detection stopped");
        }

        function resetSystem() {
            stopDetection();
            kernelSystem = null;
            ce1System = null;
            cvSystem = null;
            isInitialized = false;
            isRunning = false;
            recentDetections = [];

            // Clear canvases
            const detectionCanvas = document.getElementById('detection-canvas');
            const overlayCanvas = document.getElementById('overlay-canvas');
            const ctx1 = detectionCanvas.getContext('2d');
            const ctx2 = overlayCanvas.getContext('2d');
            ctx1.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
            ctx2.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            updateButtons();
            updateStats();
            updateDetectionsList();
            updateKernelStatus();
            updateStatus("System reset");
        }

        function handleFrameProcessed(result) {
            const { detections, processingTime, stats } = result;

            // Update processing indicator
            const indicator = document.getElementById('processing-indicator');
            indicator.classList.toggle('active', detections.length > 0);

            // Update video feed in detection canvas
            if (!isRunning) return;

            const video = document.getElementById('video-feed');
            const detectionCanvas = document.getElementById('detection-canvas');
            const ctx = detectionCanvas.getContext('2d');

            if (video.videoWidth > 0) {
                ctx.drawImage(video, 0, 0, detectionCanvas.width, detectionCanvas.height);
            }

            // Visualize detections
            const overlayCanvas = document.getElementById('overlay-canvas');
            cvSystem.visualizeDetections(overlayCanvas, detections);

            // Update recent detections
            recentDetections.unshift(...detections);
            if (recentDetections.length > 50) {
                recentDetections = recentDetections.slice(0, 50);
            }

            updateStats(stats);
            updateDetectionsList();
        }

        function updateButtons() {
            const initBtn = document.getElementById('init-btn');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            initBtn.disabled = isInitialized;
            startBtn.disabled = !isInitialized || isRunning;
            stopBtn.disabled = !isRunning;
        }

        function updateStats(stats) {
            if (!stats) return;

            document.getElementById('fps-value').textContent = stats.fps.toFixed(1);
            document.getElementById('detections-value').textContent = stats.detections;
            document.getElementById('confidence-value').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
            document.getElementById('processing-value').textContent = stats.avgProcessingTime.toFixed(1) + 'ms';
        }

        function updateDetectionsList() {
            const list = document.getElementById('detection-list');
            const items = recentDetections.slice(0, 10).map(detection => `
                <div class="detection-item">
                    <div><strong>${detection.kernelId}</strong> @ (${detection.position.x.toFixed(0)}, ${detection.position.y.toFixed(0)})</div>
                    <div>Confidence: ${(detection.confidence * 100).toFixed(1)}% | Scale: ${detection.scale.toFixed(2)}</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${detection.confidence * 100}%"></div>
                    </div>
                </div>
            `).join('');

            list.innerHTML = items || '<div style="color: #666; font-style: italic;">No detections yet...</div>';
        }

        function updateKernelStatus() {
            const status = document.getElementById('kernel-status');

            if (!kernelSystem || !kernelSystem.kernels) {
                status.innerHTML = '<div style="color: #666; font-style: italic;">Kernels not loaded</div>';
                return;
            }

            const items = Array.from(kernelSystem.kernels.keys()).map(kernelId => `
                <div class="kernel-item kernel-active">
                    ${kernelId}
                </div>
            `).join('');

            status.innerHTML = items;
        }

        function updateStatus(message) {
            console.log(message);
            // Could add status display here
        }

        function exportData() {
            if (!cvSystem) {
                alert('No data to export. Initialize system first.');
                return;
            }

            const data = cvSystem.exportDetectionData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `svg-kernel-cv-data-${new Date().toISOString().slice(0, 19)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateStatus('Detection data exported');
        }

        // Settings event listeners
        document.getElementById('confidence-threshold').addEventListener('input', (e) => {
            settings.confidenceThreshold = parseFloat(e.target.value);
            document.getElementById('confidence-value-display').textContent = settings.confidenceThreshold;
        });

        document.getElementById('detection-threshold').addEventListener('input', (e) => {
            settings.detectionThreshold = parseFloat(e.target.value);
            document.getElementById('detection-value-display').textContent = settings.detectionThreshold;
        });

        document.getElementById('nms-threshold').addEventListener('input', (e) => {
            settings.nmsThreshold = parseFloat(e.target.value);
            document.getElementById('nms-value-display').textContent = settings.nmsThreshold;
        });

        document.getElementById('temporal-filter').addEventListener('change', (e) => {
            settings.temporalFilter = e.target.checked;
        });

        document.getElementById('show-debug').addEventListener('change', (e) => {
            settings.showDebug = e.target.checked;
        });

        // Initialize settings display
        document.getElementById('confidence-value-display').textContent = settings.confidenceThreshold;
        document.getElementById('detection-value-display').textContent = settings.detectionThreshold;
        document.getElementById('nms-value-display').textContent = settings.nmsThreshold;

        // Initial status
        updateStatus("Ready to initialize. Click 'Initialize CV' to begin.");
    </script>
</body>
</html>

